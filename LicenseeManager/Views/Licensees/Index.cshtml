@model IEnumerable<LicenseeManager.Models.Licensee>

@{
    ViewData["Title"] = "Licensee Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1>Licensees</h1>

<p>
    <a asp-action="Create" class="btn btn-primary">Create New</a>
</p>

<div class="row mb-3">
    <div class="col-md-4">
        <input id="searchBox" class="form-control" placeholder="Search by first or last name..." />
    </div>
    <div class="col-md-2">
        <button id="searchButton" class="btn btn-secondary w-100">Search</button>
    </div>
    <div class="col-md-2">
        <button id="clearButton" class="btn btn-outline-secondary w-100">Clear</button>
    </div>
</div>

<div id="licenseeTableContainer">
    @Html.Partial("_LicenseeTable", Model)
</div>

@section Scripts {
    <script>
        function attachRowBehaviors() {
            // Row hover highlight
            document.querySelectorAll("#licenseeTableContainer table tbody tr").forEach(row => {
                row.addEventListener("mouseenter", () => row.style.backgroundColor = "#ffffcc");
                row.addEventListener("mouseleave", () => row.style.backgroundColor = "");
            });

            // Confirm delete
            document.querySelectorAll("#licenseeTableContainer a.delete-link").forEach(link => {
                link.addEventListener("click", function (e) {
                    if (!confirm("Are you sure you want to delete this licensee?")) {
                        e.preventDefault();
                    }
                });
            });
        }

        // Initial attach
        attachRowBehaviors();

        document.getElementById("searchButton").addEventListener("click", function () {
            const term = document.getElementById("searchBox").value;

            fetch('@Url.Action("Search", "Licensees")?term=' + encodeURIComponent(term))
                .then(response => response.text())
                .then(html => {
                    document.getElementById("licenseeTableContainer").innerHTML = html;
                    attachRowBehaviors(); // reattach events for new rows
                })
                .catch(error => console.error("Search error:", error));
        });

        document.getElementById("clearButton").addEventListener("click", function () {
            document.getElementById("searchBox").value = "";

            fetch('@Url.Action("Search", "Licensees")')
                .then(response => response.text())
                .then(html => {
                    document.getElementById("licenseeTableContainer").innerHTML = html;
                    attachRowBehaviors();
                })
                .catch(error => console.error("Clear error:", error));
        });

        document.getElementById("searchBox").addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
                document.getElementById("searchButton").click();
            }
        });

        let currentSort = { sortBy: "", sortOrder: "asc" };

        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("sort-link")) {
                e.preventDefault();

                const sortBy = e.target.dataset.sort;
                if (currentSort.sortBy === sortBy) {
                    currentSort.sortOrder = currentSort.sortOrder === "asc" ? "desc" : "asc";
                } else {
                    currentSort.sortBy = sortBy;
                    currentSort.sortOrder = "asc";
                }

                const term = document.getElementById("searchBox")?.value ?? "";

                fetch(`@Url.Action("Search", "Licensees")?term=${encodeURIComponent(term)}&sortBy=${sortBy}&sortOrder=${currentSort.sortOrder}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById("licenseeTableContainer").innerHTML = html;
                        attachRowBehaviors();

                        // Update arrows
                        document.querySelectorAll(".sort-link").forEach(link => link.classList.remove("active", "asc", "desc"));
                        const activeLink = document.querySelector(`.sort-link[data-sort='${currentSort.sortBy}']`);
                        if (activeLink) activeLink.classList.add("active", currentSort.sortOrder);
                    })
                    .catch(error => console.error("Sort error:", error));
            }
        });
    </script>
}
